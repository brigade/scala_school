<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Scala School - Testing with ScalaTest</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link rel="stylesheet" href="bootstrap-1.1.0.min.css">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39101739-7', 'twitter.github.io');
      ga('send', 'pageview');

    </script>
  </head>

  <body>
  
    <div class="topbar">
      <div class="fill">
        <div class="container fixed">
          <h3><a href="index.html">Testing with ScalaTest</a></h3>
          <ul class="nav secondary-nav">
            
              <li><a href="coll2.html">&laquo;Previous</a></li>
            
            
              <li><a href="concurrency.html">Next&raquo;</a></li>
            
          </ul>

        </div>
      </div>
    </div>

    <div class="container" style="padding-top: 60px;">
      <p>This lesson covers testing with <a href="http://www.scalatest.org/">ScalaTest</a>, a flexible Scala testing framework. There are many ways of using ScalaTest, as it doesn&#8217;t impose a testing philosophy on the user, so we will only talk about how we use it at Brigade.</p>
<ul>
	<li><a href="#example">WordSpec</a></li>
	<li><a href="#setup">Setup and TearDown</a></li>
	<li><a href="#matchers">Matchers</a></li>
	<li><a href="#mocks">Mocks</a></li>
	<li><a href="#spies">Spies</a></li>
	<li><a href="#mvn">run with mvn</a></li>
	<li><a href="#exercise">Exercise</a></li>
</ul>
<h2 id="example">WordSpec</h2>
<p>We chose to use WordSpec because of its similarity to RSpec. We use the Matchers trait to express assertions in a more readable way. Let&#8217;s just jump in.</p>
<pre>
import org.scalatest.{Matchers, WordSpec}

class ArithmeticSpec extends WordSpec with Matchers {
  "Arithmetic" should {
    "add two numbers" in {
      1 + 1 should equal(2)
    }
    "add three numbers" in {
      1 + 1 + 1 should equal(3)
    }
  }
}
</pre>
<p><strong>Arithmetic</strong> is the <strong>System Under Specification</strong></p>
<p><strong>add</strong> is a context.</p>
<p><strong>add two numbers</strong> and <strong>add three numbers</strong> are examples.</p>
<p><code>should equal</code> indicates an <strong>expectation</strong></p>
<p><code>1 should equal(1)</code> is a common placeholder <strong>expectation</strong> before you start writing real tests.  All examples should have at least one expectation.</p>
<h3>Duplication</h3>
<p>Notice how two tests both have <code>add</code> in their name?  We can get rid of that by <strong>nesting</strong> expectations.</p>
<pre>
import org.scalatest.{Matchers, WordSpec}

class ArithmeticSpec extends WordSpec with Matchers {
  "Arithmetic" should {
    "add" in {
      "two numbers" in {
        1 + 1 should equal(2)
      }
      "three numbers" in {
        1 + 1 + 1 should equal(3)
      }
    }
  }
}
</pre>
<h2 id="setup">Setup, Teardown</h2>
<h3>BeforeAndAfterAll</h3>
<p>The BeforeAndAfterAll trait can be used to perform side effects before and/or after all tests run.</p>
<pre>
class ASpec extends WordSpec with Matchers with BeforeAndAfterAll {
  override def beforeAll(): Unit = {
    setup() // setup things before all tests
  }

  override def afterAll(): Unit = {
    tearDown() // cleanup after all tests
  }

  "my code" should {
    "do stuff" in {...}
  }
}
</pre>
<h3>BeforeAndAfterEach</h3>
<p>Similarly, BeforeAndAfterEach can be used to perform side effects before and/or after each test.</p>
<pre>
class BSpec extends WordSpec with Matchers with BeforeAndAfterEach {
  var service = null

  override def beforeEach(): Unit = {
    service = MockService()
  }

  override def afterEach(): Unit = {
    service.tearDown()
  }

  "my code" should {
    "do stuff with service" in {...}
  }
}
</pre>
<h2 id="matchers">Matchers</h2>
<p>You have data, you want to make sure it&#8217;s right. Let&#8217;s tour commonly used matchers.</p>
<p>h3.</p>
<p>We&#8217;ve seen several examples of <code>should equal</code> already.</p>
<pre>
1 should equal(1)

"a" should equal("a")
</pre>
<p>Reference equality, value equality.</p>
<h3>elements in a Sequence</h3>
<pre>
val numbers = Seq(1, 2, 3)

numbers should contain(1)
numbers should not contain(4)

numbers should contain allOf(1, 2, 3)
numbers should contain theSameElementsAs Seq(1, 2, 3)
numbers should contain inOrderOnly(1, 2, 3)
numbers should contain theSameElementsInOrderAs Seq(1, 2, 3)
</pre>
<h3>Items in a Map</h3>
<pre>
map should contain key(k)
map should not contain key(k)

map should contain value(v)
map should not contain value(v)
</pre>
<h3>Numbers</h3>
<pre>
a should be &gt; b
a should be &gt;= b

a should be &lt; b
a should be &lt;= b

a should equal(b +- delta)
</pre>
<h3>Options</h3>
<pre>
a shouldEqual None

a shouldBe defined

a should equal(Some(value))
</pre>
<h3>Exceptions</h3>
<pre>
a [IndexOutOfBoundsException] should be thrownBy s.charAt(-1)
</pre>
<p>This is shorter than a try catch with a fail in the body.</p>
<p>You can also expect a specific message</p>
<pre>
val thrown = the [IndexOutOfBoundsException] thrownBy s.charAt(-1)
thrown.getMessage should equal("message")
</pre>
<p>You can also match on the exception:</p>
<pre>
the [IndexOutOfBoundsException] thrownBy {
  s.charAt(-1)
} should have message "String index out of range: -1"
</pre>
<p>You can also state that no exception should be thrown by some code, like this:</p>
<pre>
noException should be thrownBy s.charAt(1)
</pre>
<h3>Write your own Matchers</h3>
<pre>
import org.specs.matcher.Matcher
</pre>
<h4>As a val</h4>
<pre>
"A matcher" should {
  "be created as a val" in {
    val beEven = new Matcher[Int] {
      def apply(n: Int) = {
        MatchResult(n % 2 == 0, "%d is odd".format(n), "%d is even".format(n))
      }
    }
    2 should beEven
  }
}
</pre>
<p>The contract is to return a tuple containing whether the expectation is true, and a message for when it is and isn&#8217;t true.</p>
<h4>As a case class</h4>
<pre>
case class BeEvenMatcher(b: Int) extends Matcher[Int]() {
  def apply(n: Int) = MatchResult(n % 2 == 0, "%d is odd".format(n), "%d is even".format(n))
}
</pre>
<p>Using a case class makes it more shareable. The Scalatest docs have suggestions on how to organize custom matchers in a trait <a href="http://www.scalatest.org/user_guide/using_matchers#usingCustomMatchers">here</a>.</p>
<h2 id="mocks">Mocks</h2>
<pre>
import org.scalatest.{Matchers, WordSpec}
import org.scalatest.mock.MockitoSugar
import org.mockito.Mockito._

abstract class Foo[T] {
  def get(i: Int): T
}

class MockExampleSpec extends WordSpec with Matchers with MockitoSugar {
  "a mock" should {
    "stub and verify" in {
      val m = mock[Foo[String]]

      when(m.get(0)) thenReturn "one"

      m.get(0)

      verify(m).get(0)
      verify(m, never()).get(1)
    }
  }
}
</pre>
<p><strong>See Also</strong> <a href="http://mockito.github.io/mockito/docs/current/org/mockito/Mockito.html">Using Mockito</a></p>
<h2 id="spies">Spies</h2>
<p>Spies can also be used in order to do some &#8220;partial mocking&#8221; of real objects:</p>
<pre>
val list = Seq[String].empty
val spiedList = spy(list)

// methods can be stubbed on a spy
spiedList.size returns 100

// other methods can also be used
spiedList.add("one")
spiedList.add("two")

// and verification can happen on a spy
there was one(spiedList).add("one")
</pre>
<p>However, working with spies can be tricky:</p>
<pre>
// if the list is empty, this will throws an IndexOutOfBoundsException
spiedList.get(0) returns "one"
</pre>
<p><code>doReturn</code> must be used in that case:</p>
<pre>
doReturn("one").when(spiedList).get(0)
</pre>
<h2 id="mvn">Run individual specs with mvn</h2>
<pre>
mvn test -DwildcardSuites=brigade.foo.bar.SomeSpec
</pre>
<p>Will run just that spec.</p>
<h2 id="exercise">Exercise</h2>
<p>Create a spec in your project to test the very trivial <code>AlignmentStringService</code> defined below:</p>
<pre>
trait AlignmentClient {
  // returns alignment percentage
  def apply(sourceProfileId: Int, targetProfileId: Int): Int
}

class AlignmentStringService(client: AlignmentClient) {
  def apply(sourceProfileId: Int, targetProfileId: Int): String = {
    val alignmentPercentage = client(sourceProfileId, targetProfileId)
    s"Profile $sourceProfileId and $targetProfileId are aligned $alignmentPercentage%!"
  }
}
</pre>
<p>Use a mock to mock out <code>AlignmentClient</code>, and write a couple of expectations using different matchers. Make sure the tests pass by running <code>mvn test</code>.</p>
    </div> <!-- /container -->

    <div id="footer">
      <div class="inner">
        <div class="container">
          <p>

          Built at <a href="http://twitter.com/twitter"
          target="_blank">@twitter</a> by
          <a href="http://twitter.com/stevej" target="_blank">@stevej</a>,
          <a href="http://twitter.com/marius" target="_blank">@marius</a>, and
          <a href="http://twitter.com/lahosken" target="_blank">@lahosken</a>
          with much help from
          <a href="http://twitter.com/evanm" target="_blank">@evanm</a>,
          <a href="http://twitter.com/sprsquish"
          target="_blank">@sprsquish</a>,
          <a href="http://twitter.com/kevino" target="_blank">@kevino</a>,
          <a href="http://twitter.com/zuercher" target="_blank">@zuercher</a>,
          <a href="http://twitter.com/timtrueman"
          target="_blank">@timtrueman</a>,
          <a href="http://twitter.com/wickman" target="_blank">@wickman</a>,
          and <a href="http://twitter.com/mccv" target="_blank">@mccv</a>;
          Russian translation by
          <a href="https://github.com/appigram">appigram</a>;
          Chinese simple translation by
          <a href="https://github.com/jasonqu">jasonqu</a>;
          Korean translation by
          <a href="https://github.com/enshahar">enshahar</a>;<br />
          <br />

          Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License v2.0</a>.
          </p>
        </div>
      </div>
    </div>

  </body>
</html>
